#!/usr/bin/env bash
set -euo pipefail

DP_NAME="DP-1"
EDP_NAME="eDP-1"

lid_state_file() {
    local f
    for f in /proc/acpi/button/lid/*/state; do
        [[ -r "$f" ]] && { echo "$f"; return 0; }
    done
    return 1
}

read_lid() {
    local f
    if f="$(lid_state_file)"; then
        awk '{print $2}' "$f" 2>/dev/null || echo "unknown"
    else
        echo "unknown"
    fi
}

dp_connected() {
    hyprctl monitors -j | jq -e --arg n "$DP_NAME" '.[] | select(.name == $n)' >/dev/null 2>&1
}

ensure_edp_enabled_layout() {
    hyprctl keyword monitor "${EDP_NAME},1920x1080@144,0x0,1" >/dev/null
    if dp_connected; then
        hyprctl keyword monitor "${DP_NAME},2560x1440@180,1920x0,1" >/dev/null
    fi
}

disable_edp() {
    hyprctl keyword monitor "${EDP_NAME},disable" >/dev/null
}

move_all_workspaces_to() {
    local target="$1"

    hyprctl workspaces -j | jq -r '.[].id' | while read -r ws; do
        [[ -n "$ws" ]] && hyprctl dispatch moveworkspacetomonitor "$ws" "$target" >/dev/null
    done

    hyprctl dispatch focusmonitor "$target" >/dev/null
}

main_loop() {
    local last_dp="unknown"
    local last_lid="unknown"

    while true; do
        local lid
        lid="$(read_lid)"

        local dp="no"
        if dp_connected; then dp="yes"; fi

        if [[ "$dp" != "$last_dp" || "$lid" != "$last_lid" ]]; then
            if [[ "$dp" == "yes" && "$lid" == "closed" ]]; then
                move_all_workspaces_to "$DP_NAME"
                disable_edp

            elif [[ "$dp" == "no" ]]; then
                ensure_edp_enabled_layout
                move_all_workspaces_to "$EDP_NAME"

            elif [[ "$dp" == "yes" && "$lid" == "open" ]]; then
                ensure_edp_enabled_layout
            fi

            last_dp="$dp"
            last_lid="$lid"
        fi

        sleep 1
    done
}

main_loop
