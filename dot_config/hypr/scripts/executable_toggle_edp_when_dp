#!/usr/bin/env bash
set -euo pipefail

DP_NAME="DP-1"
EDP_NAME="eDP-1"

notify() {
    local title="$1"
    local body="$2"

    if command -v notify-send >/dev/null 2>&1; then
        notify-send -a "hypr" -i "video-display" "$title" "$body" >/dev/null 2>&1 || true
        return 0
    fi

    # Fallback: Hyprland built-in notification overlay
    if command -v hyprctl >/dev/null 2>&1; then
        # hyprctl notify <icon> <time_ms> <color> <message>
        # icon: -1 uses default
        # color is ARGB hex, e.g. 0xffa0a0a0
        hyprctl notify -1 2000 0xffa0a0a0 "${title}: ${body}" >/dev/null 2>&1 || true
        return 0
    fi
}

dp_connected() {
    hyprctl monitors -j | jq -e --arg n "$DP_NAME" '.[] | select(.name == $n)' >/dev/null 2>&1
}

edp_disabled() {
    hyprctl monitors -j | jq -e --arg n "$EDP_NAME" '.[] | select(.name == $n and .disabled == true)' >/dev/null 2>&1
}

ensure_layout() {
    hyprctl keyword monitor "${EDP_NAME},1920x1080@144,0x0,1" >/dev/null
    if dp_connected; then
        hyprctl keyword monitor "${DP_NAME},2560x1440@180,1920x0,1" >/dev/null
    fi
}

disable_edp() {
    hyprctl keyword monitor "${EDP_NAME},disable" >/dev/null
}

move_all_workspaces_to() {
    local target="$1"
    hyprctl workspaces -j | jq -r '.[].id' | while read -r ws; do
        [[ -n "$ws" ]] && hyprctl dispatch moveworkspacetomonitor "$ws" "$target" >/dev/null
    done
    hyprctl dispatch focusmonitor "$target" >/dev/null
}

main() {
    if dp_connected; then
        if edp_disabled; then
            # Toggle ON: re-enable eDP-1 and restore layout
            ensure_layout
            move_all_workspaces_to "$EDP_NAME"
            notify "Display toggled" "DP-1 connected. Enabled eDP-1 and moved workspaces to eDP-1."
        else
            # Toggle OFF: disable eDP-1 and move workspaces to DP-1
            move_all_workspaces_to "$DP_NAME"
            disable_edp
            notify "Display toggled" "DP-1 connected. Moved workspaces to DP-1 and disabled eDP-1."
        fi
    else
        ensure_layout
        move_all_workspaces_to "$EDP_NAME"
        notify "Display toggled" "DP-1 not connected. Restored eDP-1 layout and moved workspaces to eDP-1."
    fi
}

main
